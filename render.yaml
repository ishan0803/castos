services:
  # 1. The Backend API (Docker Container)
  - type: web
    name: castos-backend
    env: docker
    dockerContext: .
    dockerfilePath: ./backend/Dockerfile
    plan: free # or 'starter' if you need more RAM
    envVars:
      - key: PROJECT_NAME
        value: CastOS
      - key: DATABASE_URL
        fromDatabase: castos-db
        property: connectionString
      - key: REDIS_URL
        fromService: castos-redis
        property: connectionString
      - key: GOOGLE_API_KEY
        sync: false # You will enter this in dashboard
      - key: CLERK_ISSUER
        sync: false # You will enter this in dashboard
      - key: CLERK_PEM_PUBLIC_KEY
        sync: false # Optional

  # 2. The Frontend (Static Site)
  - type: web
    name: castos-frontend
    env: static
    buildCommand: cd frontend && npm install && npm run build
    staticPublishPath: ./frontend/dist
    routes:
      - type: rewrite
        source: /api/*
        destination: https://castos-backend.onrender.com/api/* # Render will auto-resolve this internal service
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VITE_CLERK_PUBLISHABLE_KEY
        sync: false

databases:
  - name: castos-db
    databaseName: castos
    user: castos_user
    plan: free # Free tier Postgres (expires in 90 days, good for testing)

# Note: Render Free Tier doesn't support managed Redis natively in Blueprints sometimes.
# If this fails, we will use an in-memory fallback or external Redis.
# For now, let's assume you might need to create Redis manually or use a starter plan.